<!-- saved from url=(0014)about:internet -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>FLARSquareDetector.as</title>
<link rel="stylesheet" type="text/css" href="../../../../../../SourceStyles.css"/>
</head>

<body><pre><span class="ActionScriptComment">/* 
 * PROJECT: FLARToolKit
 * --------------------------------------------------------------------------------
 * This work is based on the NyARToolKit developed by
 *   R.Iizuka (nyatla)
 * http://nyatla.jp/nyatoolkit/
 *
 * The FLARToolKit is ActionScript 3.0 version ARToolkit class library.
 * Copyright (C)2008 Saqoosha
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation; either version 2
 * of the License, or (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with this framework; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
 * 
 * For further information please contact.
 *    http://www.libspark.org/wiki/saqoosha/FLARToolKit
 *    &lt;saq(at)saqoosha.net&gt;
 * 
 */</span>

<span class="ActionScriptpackage">package</span> <span class="ActionScriptDefault_Text">org</span>.<span class="ActionScriptDefault_Text">libspark</span>.<span class="ActionScriptDefault_Text">flartoolkit</span>.<span class="ActionScriptDefault_Text">core</span> <span class="ActionScriptBracket/Brace">{</span>
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">org</span>.<span class="ActionScriptDefault_Text">libspark</span>.<span class="ActionScriptDefault_Text">flartoolkit</span>.<span class="ActionScriptDefault_Text">core</span>.<span class="ActionScriptDefault_Text">labeling</span>.<span class="ActionScriptDefault_Text">FLARLabelingImageBitmapData</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">org</span>.<span class="ActionScriptDefault_Text">libspark</span>.<span class="ActionScriptDefault_Text">flartoolkit</span>.<span class="ActionScriptDefault_Text">core</span>.<span class="ActionScriptDefault_Text">labeling</span>.<span class="ActionScriptDefault_Text">FLARLabelingLabel</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">org</span>.<span class="ActionScriptDefault_Text">libspark</span>.<span class="ActionScriptDefault_Text">flartoolkit</span>.<span class="ActionScriptDefault_Text">core</span>.<span class="ActionScriptDefault_Text">labeling</span>.<span class="ActionScriptDefault_Text">FLARLabelingLabelStack</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">org</span>.<span class="ActionScriptDefault_Text">libspark</span>.<span class="ActionScriptDefault_Text">flartoolkit</span>.<span class="ActionScriptDefault_Text">core</span>.<span class="ActionScriptDefault_Text">labeling</span>.<span class="ActionScriptDefault_Text">FLARLabeling_BitmapData</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">org</span>.<span class="ActionScriptDefault_Text">libspark</span>.<span class="ActionScriptDefault_Text">flartoolkit</span>.<span class="ActionScriptDefault_Text">core</span>.<span class="ActionScriptDefault_Text">labeling</span>.<span class="ActionScriptDefault_Text">IFLARLabeling</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">org</span>.<span class="ActionScriptDefault_Text">libspark</span>.<span class="ActionScriptDefault_Text">flartoolkit</span>.<span class="ActionScriptDefault_Text">core</span>.<span class="ActionScriptDefault_Text">labeling</span>.<span class="ActionScriptDefault_Text">IFLARLabelingImage</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">org</span>.<span class="ActionScriptDefault_Text">libspark</span>.<span class="ActionScriptDefault_Text">flartoolkit</span>.<span class="ActionScriptDefault_Text">core</span>.<span class="ActionScriptDefault_Text">param</span>.<span class="ActionScriptDefault_Text">FLARCameraDistortionFactor</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">org</span>.<span class="ActionScriptDefault_Text">libspark</span>.<span class="ActionScriptDefault_Text">flartoolkit</span>.<span class="ActionScriptDefault_Text">core</span>.<span class="ActionScriptDefault_Text">raster</span>.<span class="ActionScriptDefault_Text">IFLARRaster</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">org</span>.<span class="ActionScriptDefault_Text">libspark</span>.<span class="ActionScriptDefault_Text">flartoolkit</span>.<span class="ActionScriptDefault_Text">core</span>.<span class="ActionScriptDefault_Text">types</span>.<span class="ActionScriptDefault_Text">FLARIntSize</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">org</span>.<span class="ActionScriptDefault_Text">libspark</span>.<span class="ActionScriptDefault_Text">flartoolkit</span>.<span class="ActionScriptDefault_Text">core</span>.<span class="ActionScriptDefault_Text">types</span>.<span class="ActionScriptDefault_Text">FLARLinear</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">org</span>.<span class="ActionScriptDefault_Text">libspark</span>.<span class="ActionScriptDefault_Text">flartoolkit</span>.<span class="ActionScriptDefault_Text">utils</span>.<span class="ActionScriptDefault_Text">ArrayUtil</span>;    

    <span class="ActionScriptASDoc">/**
     * イメージから正方形候補を検出するクラス。
     * このクラスは、arDetectMarker2.cとの置き換えになります。
     * 
     */</span>
    <span class="ActionScriptReserved">public</span> <span class="ActionScriptclass">class</span> <span class="ActionScriptDefault_Text">FLARSquareDetector</span> <span class="ActionScriptReserved">implements</span> <span class="ActionScriptDefault_Text">IFLARSquareDetector</span> <span class="ActionScriptBracket/Brace">{</span>

        <span class="ActionScriptReserved">private</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">VERTEX_FACTOR</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> 1.0; <span class="ActionScriptComment">// 線検出のファクタ
</span>
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">AR_AREA_MAX</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> 100000; <span class="ActionScriptComment">// #define AR_AREA_MAX 100000
</span>
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">AR_AREA_MIN</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> 70; <span class="ActionScriptComment">// #define AR_AREA_MIN 70
</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_width</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>;
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_height</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>;

        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_labeling</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">IFLARLabeling</span>;

        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_limage</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">IFLARLabelingImage</span>;

        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_overlap_checker</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">OverlapChecker</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">OverlapChecker</span><span class="ActionScriptBracket/Brace">()</span>;
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_dist_factor_ref</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">FLARCameraDistortionFactor</span>;

        <span class="ActionScriptASDoc">/**
         * 最大i_squre_max個のマーカーを検出するクラスを作成する。
         * 
         * @param i_param
         */</span>
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">FLARSquareDetector</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i_dist_factor_ref</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">FLARCameraDistortionFactor</span>, <span class="ActionScriptDefault_Text">i_size</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">FLARIntSize</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">_width</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">i_size</span>.<span class="ActionScriptDefault_Text">w</span>;
            <span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">_height</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">i_size</span>.<span class="ActionScriptDefault_Text">h</span>;
            <span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">_dist_factor_ref</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">i_dist_factor_ref</span>;
<span class="ActionScriptComment">//            this._labeling = new FLARLabeling_ARToolKit();
</span>            <span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">_labeling</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">FLARLabeling_BitmapData</span><span class="ActionScriptBracket/Brace">()</span>;
<span class="ActionScriptComment">//            this._limage = new FLARLabelingImage(this._width, this._height);
</span>            <span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">_limage</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">FLARLabelingImageBitmapData</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">_width</span>, <span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">_height</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">_labeling</span>.<span class="ActionScriptDefault_Text">attachDestination</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">_limage</span><span class="ActionScriptBracket/Brace">)</span>;

            <span class="ActionScriptComment">// 輪郭の最大長は画面に映りうる最大の長方形サイズ。
</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">number_of_coord</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">_width</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">_height</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">*</span> 2;

            <span class="ActionScriptComment">// 輪郭バッファは頂点変換をするので、輪郭バッファの２倍取る。
</span>            <span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">_max_coord</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">number_of_coord</span>;
            <span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">_xcoord</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Array</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">number_of_coord</span> <span class="ActionScriptOperator">*</span> 2<span class="ActionScriptBracket/Brace">)</span>;<span class="ActionScriptComment">//new int[number_of_coord * 2];
</span>            <span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">_ycoord</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Array</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">number_of_coord</span> <span class="ActionScriptOperator">*</span> 2<span class="ActionScriptBracket/Brace">)</span>;<span class="ActionScriptComment">//new int[number_of_coord * 2];
</span>        <span class="ActionScriptBracket/Brace">}</span>

        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_max_coord</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>;
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_xcoord</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span>; <span class="ActionScriptComment">// int[]
</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_ycoord</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span>; <span class="ActionScriptComment">// int[]
</span>
        <span class="ActionScriptASDoc">/**
         * @param i_coord_x    int[]
         * @param i_coord_y    int[]
         */</span>
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">normalizeCoord</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i_coord_x</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span>, <span class="ActionScriptDefault_Text">i_coord_y</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span>, <span class="ActionScriptDefault_Text">i_index</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>, <span class="ActionScriptDefault_Text">i_coord_num</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptComment">// vertex1を境界にして、後方に配列を連結
</span>            <span class="ActionScriptDefault_Text">ArrayUtil</span>.<span class="ActionScriptDefault_Text">copy</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i_coord_x</span>, 1, <span class="ActionScriptDefault_Text">i_coord_x</span>, <span class="ActionScriptDefault_Text">i_coord_num</span>, <span class="ActionScriptDefault_Text">i_index</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">ArrayUtil</span>.<span class="ActionScriptDefault_Text">copy</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i_coord_y</span>, 1, <span class="ActionScriptDefault_Text">i_coord_y</span>, <span class="ActionScriptDefault_Text">i_coord_num</span>, <span class="ActionScriptDefault_Text">i_index</span><span class="ActionScriptBracket/Brace">)</span>;
<span class="ActionScriptComment">//        System.arraycopy(i_coord_x, 1, i_coord_x, i_coord_num, i_index);
</span><span class="ActionScriptComment">//        System.arraycopy(i_coord_y, 1, i_coord_y, i_coord_num, i_index);
</span>        <span class="ActionScriptBracket/Brace">}</span>

        <span class="ActionScriptComment">//    private final int[] __detectMarker_mkvertex = new int[5];
</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">__detectMarker_mkvertex</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Array</span><span class="ActionScriptBracket/Brace">(</span>5<span class="ActionScriptBracket/Brace">)</span>;

        <span class="ActionScriptASDoc">/**
         * ARMarkerInfo2 *arDetectMarker2( ARInt16 *limage, int label_num, int *label_ref,int *warea, double *wpos, int *wclip,int area_max, int area_min, double
         * factor, int *marker_num ) 関数の代替品 ラベリング情報からマーカー一覧を作成してo_marker_listを更新します。 関数はo_marker_listに重なりを除外したマーカーリストを作成します。
         * 
         * @param i_raster
         * 解析する２値ラスタイメージを指定します。
         * @param o_square_stack
         * 抽出した正方形候補を格納するリスト
         * @throws FLARException
         */</span>
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">detectMarker</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i_raster</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">IFLARRaster</span>, <span class="ActionScriptDefault_Text">o_square_stack</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">FLARSquareStack</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">labeling_proc</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">IFLARLabeling</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">_labeling</span>;
            <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">limage</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">IFLARLabelingImage</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">_limage</span>;

            <span class="ActionScriptComment">// 初期化
</span>
            <span class="ActionScriptComment">// マーカーホルダをリセット
</span>            <span class="ActionScriptDefault_Text">o_square_stack</span>.<span class="ActionScriptDefault_Text">clear</span><span class="ActionScriptBracket/Brace">()</span>;

            <span class="ActionScriptComment">// ラベリング
</span>            <span class="ActionScriptDefault_Text">labeling_proc</span>.<span class="ActionScriptDefault_Text">labeling</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i_raster</span><span class="ActionScriptBracket/Brace">)</span>;

            <span class="ActionScriptComment">// ラベル数が0ならここまで
</span>            <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">label_num</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">limage</span>.<span class="ActionScriptDefault_Text">getLabelStack</span><span class="ActionScriptBracket/Brace">()</span>.<span class="ActionScriptDefault_Text">getLength</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">label_num</span> <span class="ActionScriptOperator">&lt;</span> 1<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptReserved">return</span>;
            <span class="ActionScriptBracket/Brace">}</span>

            <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">stack</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">FLARLabelingLabelStack</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">limage</span>.<span class="ActionScriptDefault_Text">getLabelStack</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">labels</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">stack</span>.<span class="ActionScriptDefault_Text">getArray</span><span class="ActionScriptBracket/Brace">()</span>; 
            <span class="ActionScriptComment">// FLARLabelingLabel[]
</span>        
        
            <span class="ActionScriptComment">// ラベルを大きい順に整列
</span>            <span class="ActionScriptDefault_Text">stack</span>.<span class="ActionScriptDefault_Text">sortByArea</span><span class="ActionScriptBracket/Brace">()</span>;

            <span class="ActionScriptComment">// デカいラベルを読み飛ばし
</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>;
            <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">=</span> 0;<span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">label_num</span>; <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptComment">// 検査対象内のラベルサイズになるまで無視
</span>                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">labels</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span>.<span class="ActionScriptDefault_Text">area</span> <span class="ActionScriptOperator">&lt;=</span> <span class="ActionScriptDefault_Text">AR_AREA_MAX</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptReserved">break</span>;
                <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptBracket/Brace">}</span>

            <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">xsize</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">_width</span>;
            <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">ysize</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">_height</span>;
            <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">xcoord</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">_xcoord</span>; <span class="ActionScriptComment">// int[]
</span>            <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">ycoord</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">_ycoord</span>; <span class="ActionScriptComment">// int[]
</span>            <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">coord_max</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">_max_coord</span>;
            <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">mkvertex</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">__detectMarker_mkvertex</span>; <span class="ActionScriptComment">// int[]
</span>            <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">overlap</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">OverlapChecker</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">_overlap_checker</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">coord_num</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">label_area</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">label_pt</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">FLARLabelingLabel</span>;

            <span class="ActionScriptComment">//重なりチェッカの最大数を設定
</span>            <span class="ActionScriptDefault_Text">overlap</span>.<span class="ActionScriptDefault_Text">reset</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">label_num</span><span class="ActionScriptBracket/Brace">)</span>;

            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">vertex1</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">square_ptr</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">FLARSquare</span>;
            <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span>;<span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">label_num</span>; <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">label_pt</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">labels</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span>;
                <span class="ActionScriptDefault_Text">label_area</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">label_pt</span>.<span class="ActionScriptDefault_Text">area</span>;
                <span class="ActionScriptComment">// 検査対象サイズよりも小さくなったら終了
</span>                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">label_area</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">AR_AREA_MIN</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptReserved">break</span>;
                <span class="ActionScriptBracket/Brace">}</span>
                <span class="ActionScriptComment">// クリップ領域が画面の枠に接していれば除外
</span>                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">label_pt</span>.<span class="ActionScriptDefault_Text">clip_l</span> <span class="ActionScriptOperator">==</span> 1 <span class="ActionScriptOperator">||</span> <span class="ActionScriptDefault_Text">label_pt</span>.<span class="ActionScriptDefault_Text">clip_r</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">xsize</span> <span class="ActionScriptOperator">-</span> 2<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptComment">// if(wclip[i*4+0] == 1 || wclip[i*4+1] ==xsize-2){
</span>                    <span class="ActionScriptReserved">continue</span>;
                <span class="ActionScriptBracket/Brace">}</span>
                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">label_pt</span>.<span class="ActionScriptDefault_Text">clip_t</span> <span class="ActionScriptOperator">==</span> 1 <span class="ActionScriptOperator">||</span> <span class="ActionScriptDefault_Text">label_pt</span>.<span class="ActionScriptDefault_Text">clip_b</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">ysize</span> <span class="ActionScriptOperator">-</span> 2<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptComment">// if( wclip[i*4+2] == 1 || wclip[i*4+3] ==ysize-2){
</span>                    <span class="ActionScriptReserved">continue</span>;
                <span class="ActionScriptBracket/Brace">}</span>
                <span class="ActionScriptComment">// 既に検出された矩形との重なりを確認
</span>                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(!</span><span class="ActionScriptDefault_Text">overlap</span>.<span class="ActionScriptDefault_Text">check</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">label_pt</span><span class="ActionScriptBracket/Brace">))</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptComment">// 重なっているようだ。
</span>                    <span class="ActionScriptReserved">continue</span>;
                <span class="ActionScriptBracket/Brace">}</span>

                <span class="ActionScriptComment">// 輪郭を取得
</span>                <span class="ActionScriptDefault_Text">coord_num</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">limage</span>.<span class="ActionScriptDefault_Text">getContour</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i</span>, <span class="ActionScriptDefault_Text">coord_max</span>, <span class="ActionScriptDefault_Text">xcoord</span>, <span class="ActionScriptDefault_Text">ycoord</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">coord_num</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">coord_max</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptComment">// 輪郭が大きすぎる。
</span>                    <span class="ActionScriptReserved">continue</span>;
                <span class="ActionScriptBracket/Brace">}</span>
                <span class="ActionScriptComment">//頂点候補のインデクスを取得
</span>                <span class="ActionScriptDefault_Text">vertex1</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">scanVertex</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">xcoord</span>, <span class="ActionScriptDefault_Text">ycoord</span>, <span class="ActionScriptDefault_Text">coord_num</span><span class="ActionScriptBracket/Brace">)</span>;

                <span class="ActionScriptComment">// 頂点候補(vertex1)を先頭に並べなおした配列を作成する。
</span>                <span class="ActionScriptDefault_Text">normalizeCoord</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">xcoord</span>, <span class="ActionScriptDefault_Text">ycoord</span>, <span class="ActionScriptDefault_Text">vertex1</span>, <span class="ActionScriptDefault_Text">coord_num</span><span class="ActionScriptBracket/Brace">)</span>;

                <span class="ActionScriptComment">// 領域を準備する。
</span>                <span class="ActionScriptDefault_Text">square_ptr</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">o_square_stack</span>.<span class="ActionScriptDefault_Text">prePush</span><span class="ActionScriptBracket/Brace">()</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">FLARSquare</span>;

                <span class="ActionScriptComment">// 頂点情報を取得
</span>                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(!</span><span class="ActionScriptDefault_Text">getSquareVertex</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">xcoord</span>, <span class="ActionScriptDefault_Text">ycoord</span>, <span class="ActionScriptDefault_Text">vertex1</span>, <span class="ActionScriptDefault_Text">coord_num</span>, <span class="ActionScriptDefault_Text">label_area</span>, <span class="ActionScriptDefault_Text">mkvertex</span><span class="ActionScriptBracket/Brace">))</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptDefault_Text">o_square_stack</span>.<span class="ActionScriptDefault_Text">pop</span><span class="ActionScriptBracket/Brace">()</span>;
                    <span class="ActionScriptComment">// 頂点の取得が出来なかったので破棄
</span>                    <span class="ActionScriptReserved">continue</span>;
                <span class="ActionScriptBracket/Brace">}</span>

                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(!</span><span class="ActionScriptDefault_Text">getSquareLine</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">mkvertex</span>, <span class="ActionScriptDefault_Text">xcoord</span>, <span class="ActionScriptDefault_Text">ycoord</span>, <span class="ActionScriptDefault_Text">square_ptr</span><span class="ActionScriptBracket/Brace">))</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptComment">// 矩形が成立しなかった。
</span>                    <span class="ActionScriptDefault_Text">o_square_stack</span>.<span class="ActionScriptDefault_Text">pop</span><span class="ActionScriptBracket/Brace">()</span>;
                    <span class="ActionScriptReserved">continue</span>;
                <span class="ActionScriptBracket/Brace">}</span>
                <span class="ActionScriptComment">// 検出済の矩形の属したラベルを重なりチェックに追加する。
</span>                <span class="ActionScriptDefault_Text">overlap</span>.<span class="ActionScriptDefault_Text">push</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">label_pt</span><span class="ActionScriptBracket/Brace">)</span>;
                
                <span class="ActionScriptComment">// 後から参照できるように
</span>                <span class="ActionScriptDefault_Text">square_ptr</span>.<span class="ActionScriptDefault_Text">label</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">label_pt</span>;
            <span class="ActionScriptBracket/Brace">}</span>    
            <span class="ActionScriptReserved">return</span>;
        <span class="ActionScriptBracket/Brace">}</span>

        <span class="ActionScriptASDoc">/**
         * 辺からの対角線が最長になる点を対角線候補として返す。
         * 
         * @param i_xcoord    int[]
         * @param i_ycoord    int[]
         * @param i_coord_num    int
         * @return
         */</span>
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">scanVertex</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i_xcoord</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span>, <span class="ActionScriptDefault_Text">i_ycoord</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span>, <span class="ActionScriptDefault_Text">i_coord_num</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">sx</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">i_xcoord</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span>;
            <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">sy</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">i_ycoord</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">d</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> 0;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">w</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">x</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">y</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">ret</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> 0;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>;
            <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">=</span> 1; <span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">i_coord_num</span>; <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">i_xcoord</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">sx</span>;
                <span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">i_ycoord</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">sy</span>;
                <span class="ActionScriptDefault_Text">w</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">y</span>;
                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">w</span> <span class="ActionScriptOperator">&gt;</span> <span class="ActionScriptDefault_Text">d</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptDefault_Text">d</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">w</span>;
                    <span class="ActionScriptDefault_Text">ret</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">i</span>;
                <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptComment">// ここでうまく終了条件入れられないかな。
</span>            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">ret</span>;
        <span class="ActionScriptBracket/Brace">}</span>

        <span class="ActionScriptReserved">private</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">__getSquareVertex_wv1</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">FLARVertexCounter</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">FLARVertexCounter</span><span class="ActionScriptBracket/Brace">()</span>;

        <span class="ActionScriptReserved">private</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">__getSquareVertex_wv2</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">FLARVertexCounter</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">FLARVertexCounter</span><span class="ActionScriptBracket/Brace">()</span>;

        <span class="ActionScriptASDoc">/**
         * static int arDetectMarker2_check_square( int area, ARMarkerInfo2 *marker_info2, double factor ) 関数の代替関数 OPTIMIZED STEP [450-&gt;415] o_squareに頂点情報をセットします。
         * 
         * @param i_x_coord    int[]
         * @param i_y_coord    int[]
         * @param i_vertex1_index
         * @param i_coord_num
         * @param i_area
         * @param o_vertex    int[]
         * 要素数はint[4]である事
         * @return
         */</span>
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">getSquareVertex</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i_x_coord</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span>, <span class="ActionScriptDefault_Text">i_y_coord</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span>, <span class="ActionScriptDefault_Text">i_vertex1_index</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>, <span class="ActionScriptDefault_Text">i_coord_num</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>, <span class="ActionScriptDefault_Text">i_area</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>, <span class="ActionScriptDefault_Text">o_vertex</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Boolean</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">wv1</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">FLARVertexCounter</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">__getSquareVertex_wv1</span>;
            <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">wv2</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">FLARVertexCounter</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">__getSquareVertex_wv2</span>;
            <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">end_of_coord</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">i_vertex1_index</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">i_coord_num</span> <span class="ActionScriptOperator">-</span> 1;
            <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">sx</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">i_x_coord</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i_vertex1_index</span><span class="ActionScriptBracket/Brace">]</span>;
            <span class="ActionScriptComment">// sx = marker_info2-&gt;x_coord[0];
</span>            <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">sy</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">i_y_coord</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i_vertex1_index</span><span class="ActionScriptBracket/Brace">]</span>;
            <span class="ActionScriptComment">// sy = marker_info2-&gt;y_coord[0];
</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">dmax</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> 0;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">v1</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">i_vertex1_index</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">d</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>;
            <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">=</span> 1 <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">i_vertex1_index</span>; <span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">end_of_coord</span>; <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptComment">// for(i=1;i&lt;marker_info2-&gt;coord_num-1;i++)
</span>                <span class="ActionScriptComment">// {
</span>                <span class="ActionScriptDefault_Text">d</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i_x_coord</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">sx</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i_x_coord</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">sx</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i_y_coord</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">sy</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i_y_coord</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">sy</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">d</span> <span class="ActionScriptOperator">&gt;</span> <span class="ActionScriptDefault_Text">dmax</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptDefault_Text">dmax</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">d</span>;
                    <span class="ActionScriptDefault_Text">v1</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">i</span>;
                <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">thresh</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i_area</span> <span class="ActionScriptOperator">/</span> 0.75<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">*</span> 0.01 <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">VERTEX_FACTOR</span>;

            <span class="ActionScriptDefault_Text">o_vertex</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">i_vertex1_index</span>;

            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(!</span><span class="ActionScriptDefault_Text">wv1</span>.<span class="ActionScriptDefault_Text">getVertex</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i_x_coord</span>, <span class="ActionScriptDefault_Text">i_y_coord</span>, <span class="ActionScriptDefault_Text">i_vertex1_index</span>, <span class="ActionScriptDefault_Text">v1</span>, <span class="ActionScriptDefault_Text">thresh</span><span class="ActionScriptBracket/Brace">))</span> <span class="ActionScriptBracket/Brace">{</span> 
                <span class="ActionScriptComment">// if(get_vertex(marker_info2-&gt;x_coord,marker_info2-&gt;y_coord,0,v1,thresh,wv1,&amp;wvnum1)&lt;
</span>                <span class="ActionScriptComment">// 0 ) {
</span>                <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">false</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(!</span><span class="ActionScriptDefault_Text">wv2</span>.<span class="ActionScriptDefault_Text">getVertex</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i_x_coord</span>, <span class="ActionScriptDefault_Text">i_y_coord</span>, <span class="ActionScriptDefault_Text">v1</span>, <span class="ActionScriptDefault_Text">end_of_coord</span>, <span class="ActionScriptDefault_Text">thresh</span><span class="ActionScriptBracket/Brace">))</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptComment">// if(get_vertex(marker_info2-&gt;x_coord,marker_info2-&gt;y_coord,v1,marker_info2-&gt;coord_num-1,thresh,wv2,&amp;wvnum2)
</span>                <span class="ActionScriptComment">// &lt; 0) {
</span>                <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">false</span>;
            <span class="ActionScriptBracket/Brace">}</span>

            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">v2</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>;
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">wv1</span>.<span class="ActionScriptDefault_Text">number_of_vertex</span> <span class="ActionScriptOperator">==</span> 1 <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptDefault_Text">wv2</span>.<span class="ActionScriptDefault_Text">number_of_vertex</span> <span class="ActionScriptOperator">==</span> 1<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptComment">// if(wvnum1 == 1 &amp;&amp; wvnum2== 1) {
</span>                <span class="ActionScriptDefault_Text">o_vertex</span><span class="ActionScriptBracket/Brace">[</span>1<span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">wv1</span>.<span class="ActionScriptDefault_Text">vertex</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span>;
                <span class="ActionScriptDefault_Text">o_vertex</span><span class="ActionScriptBracket/Brace">[</span>2<span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">v1</span>;
                <span class="ActionScriptDefault_Text">o_vertex</span><span class="ActionScriptBracket/Brace">[</span>3<span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">wv2</span>.<span class="ActionScriptDefault_Text">vertex</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span>;
            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">wv1</span>.<span class="ActionScriptDefault_Text">number_of_vertex</span> <span class="ActionScriptOperator">&gt;</span> 1 <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptDefault_Text">wv2</span>.<span class="ActionScriptDefault_Text">number_of_vertex</span> <span class="ActionScriptOperator">==</span> 0<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptComment">// }else if( wvnum1 &gt; 1 &amp;&amp; wvnum2== 0) {
</span>                <span class="ActionScriptComment">//頂点位置を、起点から対角点の間の1/2にあると予想して、検索する。
</span>                <span class="ActionScriptDefault_Text">v2</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">v1</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">i_vertex1_index</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">/</span> 2 <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">i_vertex1_index</span>;
                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(!</span><span class="ActionScriptDefault_Text">wv1</span>.<span class="ActionScriptDefault_Text">getVertex</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i_x_coord</span>, <span class="ActionScriptDefault_Text">i_y_coord</span>, <span class="ActionScriptDefault_Text">i_vertex1_index</span>, <span class="ActionScriptDefault_Text">v2</span>, <span class="ActionScriptDefault_Text">thresh</span><span class="ActionScriptBracket/Brace">))</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">false</span>;
                <span class="ActionScriptBracket/Brace">}</span>
                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(!</span><span class="ActionScriptDefault_Text">wv2</span>.<span class="ActionScriptDefault_Text">getVertex</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i_x_coord</span>, <span class="ActionScriptDefault_Text">i_y_coord</span>, <span class="ActionScriptDefault_Text">v2</span>, <span class="ActionScriptDefault_Text">v1</span>, <span class="ActionScriptDefault_Text">thresh</span><span class="ActionScriptBracket/Brace">))</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">false</span>;
                <span class="ActionScriptBracket/Brace">}</span>
                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">wv1</span>.<span class="ActionScriptDefault_Text">number_of_vertex</span> <span class="ActionScriptOperator">==</span> 1 <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptDefault_Text">wv2</span>.<span class="ActionScriptDefault_Text">number_of_vertex</span> <span class="ActionScriptOperator">==</span> 1<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptDefault_Text">o_vertex</span><span class="ActionScriptBracket/Brace">[</span>1<span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">wv1</span>.<span class="ActionScriptDefault_Text">vertex</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span>;
                    <span class="ActionScriptDefault_Text">o_vertex</span><span class="ActionScriptBracket/Brace">[</span>2<span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">wv2</span>.<span class="ActionScriptDefault_Text">vertex</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span>;
                    <span class="ActionScriptDefault_Text">o_vertex</span><span class="ActionScriptBracket/Brace">[</span>3<span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">v1</span>;
                <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">false</span>;
                <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">wv1</span>.<span class="ActionScriptDefault_Text">number_of_vertex</span> <span class="ActionScriptOperator">==</span> 0 <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptDefault_Text">wv2</span>.<span class="ActionScriptDefault_Text">number_of_vertex</span> <span class="ActionScriptOperator">&gt;</span> 1<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptComment">//v2 = (v1-i_vertex1_index+ end_of_coord-i_vertex1_index) / 2+i_vertex1_index;
</span>                <span class="ActionScriptDefault_Text">v2</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">v1</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">end_of_coord</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">/</span> 2;

                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(!</span><span class="ActionScriptDefault_Text">wv1</span>.<span class="ActionScriptDefault_Text">getVertex</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i_x_coord</span>, <span class="ActionScriptDefault_Text">i_y_coord</span>, <span class="ActionScriptDefault_Text">v1</span>, <span class="ActionScriptDefault_Text">v2</span>, <span class="ActionScriptDefault_Text">thresh</span><span class="ActionScriptBracket/Brace">))</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">false</span>;
                <span class="ActionScriptBracket/Brace">}</span>
                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(!</span><span class="ActionScriptDefault_Text">wv2</span>.<span class="ActionScriptDefault_Text">getVertex</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i_x_coord</span>, <span class="ActionScriptDefault_Text">i_y_coord</span>, <span class="ActionScriptDefault_Text">v2</span>, <span class="ActionScriptDefault_Text">end_of_coord</span>, <span class="ActionScriptDefault_Text">thresh</span><span class="ActionScriptBracket/Brace">))</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">false</span>;
                <span class="ActionScriptBracket/Brace">}</span>
                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">wv1</span>.<span class="ActionScriptDefault_Text">number_of_vertex</span> <span class="ActionScriptOperator">==</span> 1 <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptDefault_Text">wv2</span>.<span class="ActionScriptDefault_Text">number_of_vertex</span> <span class="ActionScriptOperator">==</span> 1<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptDefault_Text">o_vertex</span><span class="ActionScriptBracket/Brace">[</span>1<span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">v1</span>;
                    <span class="ActionScriptDefault_Text">o_vertex</span><span class="ActionScriptBracket/Brace">[</span>2<span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">wv1</span>.<span class="ActionScriptDefault_Text">vertex</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span>;
                    <span class="ActionScriptDefault_Text">o_vertex</span><span class="ActionScriptBracket/Brace">[</span>3<span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">wv2</span>.<span class="ActionScriptDefault_Text">vertex</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span>;
                <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">false</span>;
                <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">false</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptDefault_Text">o_vertex</span><span class="ActionScriptBracket/Brace">[</span>4<span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">end_of_coord</span>;
            <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">true</span>;
        <span class="ActionScriptBracket/Brace">}</span>

        <span class="ActionScriptReserved">private</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">__getSquareLine_input</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">FLARMat</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">FLARMat</span><span class="ActionScriptBracket/Brace">(</span>1, 2<span class="ActionScriptBracket/Brace">)</span>;

        <span class="ActionScriptReserved">private</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">__getSquareLine_evec</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">FLARMat</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">FLARMat</span><span class="ActionScriptBracket/Brace">(</span>2, 2<span class="ActionScriptBracket/Brace">)</span>;

        <span class="ActionScriptReserved">private</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">__getSquareLine_ev</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">FLARVec</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">FLARVec</span><span class="ActionScriptBracket/Brace">(</span>2<span class="ActionScriptBracket/Brace">)</span>;

        <span class="ActionScriptReserved">private</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">__getSquareLine_mean</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">FLARVec</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">FLARVec</span><span class="ActionScriptBracket/Brace">(</span>2<span class="ActionScriptBracket/Brace">)</span>;

        <span class="ActionScriptASDoc">/**
         * arGetLine(int x_coord[], int y_coord[], int coord_num,int vertex[], double line[4][3], double v[4][2]) arGetLine2(int x_coord[], int y_coord[], int
         * coord_num,int vertex[], double line[4][3], double v[4][2], double *dist_factor) の２関数の合成品です。 マーカーのvertex,lineを計算して、結果をo_squareに保管します。
         * Optimize:STEP[424-&gt;391]
         * 
         * @param i_mkvertex    int[]
         * @param i_xcoord    int[]
         * @param i_ycoord    int[]
         * @param o_square
         * @return
         * @throws FLARException
         */</span>
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">getSquareLine</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i_mkvertex</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span>, <span class="ActionScriptDefault_Text">i_xcoord</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span>, <span class="ActionScriptDefault_Text">i_ycoord</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span>, <span class="ActionScriptDefault_Text">o_square</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">FLARSquare</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Boolean</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">l_line</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">o_square</span>.<span class="ActionScriptDefault_Text">line</span>; <span class="ActionScriptComment">// FLARLinear[]
</span>            <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">ev</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">FLARVec</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">__getSquareLine_ev</span>; <span class="ActionScriptComment">// matrixPCAの戻り値を受け取る
</span>            <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">mean</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">FLARVec</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">__getSquareLine_mean</span>; <span class="ActionScriptComment">// matrixPCAの戻り値を受け取る
</span>            <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">mean_array</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">mean</span>.<span class="ActionScriptDefault_Text">getArray</span><span class="ActionScriptBracket/Brace">()</span>; <span class="ActionScriptComment">// double[]
</span>            <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">dist_factor</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">FLARCameraDistortionFactor</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">_dist_factor_ref</span>;  
            <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">input</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">FLARMat</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">__getSquareLine_input</span>;
            <span class="ActionScriptComment">// 次処理で初期化される。
</span>            <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">evec</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">FLARMat</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">__getSquareLine_evec</span>;
            <span class="ActionScriptComment">// アウトパラメータを受け取るから初期化不要//new FLARMat(2,2);
</span>            <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">evec_array</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">evec</span>.<span class="ActionScriptDefault_Text">getArray</span><span class="ActionScriptBracket/Brace">()</span>; <span class="ActionScriptComment">// double[][]
</span>            
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">w1</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Number</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">st</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">ed</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">n</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">l_line_i</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">FLARLinear</span>;
            <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">&lt;</span> 4; <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">w1</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i_mkvertex</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">+</span> 1<span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">i_mkvertex</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">+</span> 1<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">*</span> 0.05 <span class="ActionScriptOperator">+</span> 0.5;
                <span class="ActionScriptDefault_Text">st</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i_mkvertex</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">w1</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">ed</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i_mkvertex</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">+</span> 1<span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">w1</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">n</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">ed</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">st</span> <span class="ActionScriptOperator">+</span> 1;
                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">n</span> <span class="ActionScriptOperator">&lt;</span> 2<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptComment">// nが2以下でmatrix.PCAを計算することはできないので、エラー
</span>                    <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">false</span>;
                <span class="ActionScriptBracket/Brace">}</span>
                <span class="ActionScriptComment">// pcaの準備
</span>                <span class="ActionScriptDefault_Text">input</span>.<span class="ActionScriptDefault_Text">realloc</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">n</span>, 2<span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptComment">// バッチ取得
</span>                <span class="ActionScriptDefault_Text">dist_factor</span>.<span class="ActionScriptDefault_Text">observ2IdealBatch</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i_xcoord</span>, <span class="ActionScriptDefault_Text">i_ycoord</span>, <span class="ActionScriptDefault_Text">st</span>, <span class="ActionScriptDefault_Text">n</span>, <span class="ActionScriptDefault_Text">input</span>.<span class="ActionScriptDefault_Text">getArray</span><span class="ActionScriptBracket/Brace">())</span>;

                <span class="ActionScriptComment">// 主成分分析
</span>                <span class="ActionScriptDefault_Text">input</span>.<span class="ActionScriptDefault_Text">matrixPCA</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">evec</span>, <span class="ActionScriptDefault_Text">ev</span>, <span class="ActionScriptDefault_Text">mean</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">l_line_i</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">l_line</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span>;
                <span class="ActionScriptDefault_Text">l_line_i</span>.<span class="ActionScriptDefault_Text">run</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">evec_array</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">][</span>1<span class="ActionScriptBracket/Brace">]</span>;
                <span class="ActionScriptComment">// line[i][0] = evec-&gt;m[1];
</span>                <span class="ActionScriptDefault_Text">l_line_i</span>.<span class="ActionScriptDefault_Text">rise</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptOperator">-</span><span class="ActionScriptDefault_Text">evec_array</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">][</span>0<span class="ActionScriptBracket/Brace">]</span>;
                <span class="ActionScriptComment">// line[i][1] = -evec-&gt;m[0];
</span>                <span class="ActionScriptDefault_Text">l_line_i</span>.<span class="ActionScriptDefault_Text">intercept</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptOperator">-</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">l_line_i</span>.<span class="ActionScriptDefault_Text">run</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">mean_array</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">l_line_i</span>.<span class="ActionScriptDefault_Text">rise</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">mean_array</span><span class="ActionScriptBracket/Brace">[</span>1<span class="ActionScriptBracket/Brace">])</span>;<span class="ActionScriptComment">// line[i][2] = -(line[i][0]*mean-&gt;v[0] + line[i][1]*mean-&gt;v[1]);
</span>            <span class="ActionScriptBracket/Brace">}</span>

            <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">l_sqvertex</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">o_square</span>.<span class="ActionScriptDefault_Text">sqvertex</span>; 
            <span class="ActionScriptComment">// FLARDoublePoint2d[]
</span>            <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">l_imvertex</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">o_square</span>.<span class="ActionScriptDefault_Text">imvertex</span>; 
            <span class="ActionScriptComment">// FLARIntPoint[]
</span>            
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">l_line_2</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">FLARLinear</span>;
            <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">&lt;</span> 4; <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">l_line_i</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">l_line</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span>;
                <span class="ActionScriptDefault_Text">l_line_2</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">l_line</span><span class="ActionScriptBracket/Brace">[(</span><span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">+</span> 3<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">%</span> 4<span class="ActionScriptBracket/Brace">]</span>;
                <span class="ActionScriptDefault_Text">w1</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">l_line_2</span>.<span class="ActionScriptDefault_Text">run</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">l_line_i</span>.<span class="ActionScriptDefault_Text">rise</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">l_line_i</span>.<span class="ActionScriptDefault_Text">run</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">l_line_2</span>.<span class="ActionScriptDefault_Text">rise</span>;
                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">w1</span> <span class="ActionScriptOperator">==</span> 0.0<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">false</span>;
                <span class="ActionScriptBracket/Brace">}</span>
                <span class="ActionScriptDefault_Text">l_sqvertex</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span>.<span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">l_line_2</span>.<span class="ActionScriptDefault_Text">rise</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">l_line_i</span>.<span class="ActionScriptDefault_Text">intercept</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">l_line_i</span>.<span class="ActionScriptDefault_Text">rise</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">l_line_2</span>.<span class="ActionScriptDefault_Text">intercept</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">/</span> <span class="ActionScriptDefault_Text">w1</span>;
                <span class="ActionScriptDefault_Text">l_sqvertex</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span>.<span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">l_line_i</span>.<span class="ActionScriptDefault_Text">run</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">l_line_2</span>.<span class="ActionScriptDefault_Text">intercept</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">l_line_2</span>.<span class="ActionScriptDefault_Text">run</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">l_line_i</span>.<span class="ActionScriptDefault_Text">intercept</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">/</span> <span class="ActionScriptDefault_Text">w1</span>;
                <span class="ActionScriptComment">// 頂点インデクスから頂点座標を得て保存
</span>                <span class="ActionScriptDefault_Text">l_imvertex</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span>.<span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">i_xcoord</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i_mkvertex</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]]</span>;
                <span class="ActionScriptDefault_Text">l_imvertex</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span>.<span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">i_ycoord</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i_mkvertex</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]]</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">true</span>;
        <span class="ActionScriptBracket/Brace">}</span>
    <span class="ActionScriptBracket/Brace">}</span>
<span class="ActionScriptBracket/Brace">}</span>

<span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">org</span>.<span class="ActionScriptDefault_Text">libspark</span>.<span class="ActionScriptDefault_Text">flartoolkit</span>.<span class="ActionScriptDefault_Text">core</span>.<span class="ActionScriptDefault_Text">labeling</span>.<span class="ActionScriptDefault_Text">FLARLabelingLabel</span>;

<span class="ActionScriptASDoc">/**
 * get_vertex関数を切り離すためのクラス
 * 
 */</span>
<span class="ActionScriptclass">class</span> <span class="ActionScriptDefault_Text">FLARVertexCounter</span> <span class="ActionScriptBracket/Brace">{</span>

    <span class="ActionScriptReserved">public</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">vertex</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Array</span><span class="ActionScriptBracket/Brace">(</span>10<span class="ActionScriptBracket/Brace">)</span>; <span class="ActionScriptComment">// = new int[10];// 5まで削れる
</span>
    <span class="ActionScriptReserved">public</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">number_of_vertex</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>;

    <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">thresh</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Number</span>;

    <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">x_coord</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span>; <span class="ActionScriptComment">// int[]
</span>
    <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">y_coord</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span>; <span class="ActionScriptComment">// int[]
</span>
    <span class="ActionScriptASDoc">/**
     * @param i_x_coord    int[]
     * @param i_y_coord    int[]
     * @param st
     * @param ed
     * @param i_thresh
     */</span>
    <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">getVertex</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i_x_coord</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span>, <span class="ActionScriptDefault_Text">i_y_coord</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span>, <span class="ActionScriptDefault_Text">st</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>, <span class="ActionScriptDefault_Text">ed</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>, <span class="ActionScriptDefault_Text">i_thresh</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Boolean</span> <span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">number_of_vertex</span> <span class="ActionScriptOperator">=</span> 0;
        <span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">thresh</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">i_thresh</span>;
        <span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">x_coord</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">i_x_coord</span>;
        <span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">y_coord</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">i_y_coord</span>;
        <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">get_vertex</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">st</span>, <span class="ActionScriptDefault_Text">ed</span><span class="ActionScriptBracket/Brace">)</span>;
    <span class="ActionScriptBracket/Brace">}</span>

    <span class="ActionScriptASDoc">/**
     * static int get_vertex( int x_coord[], int y_coord[], int st, int ed,double thresh, int vertex[], int *vnum) 関数の代替関数
     * 
     * @param x_coord
     * @param y_coord
     * @param st
     * @param ed
     * @param thresh
     * @return
     */</span>
    <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">get_vertex</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">st</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>, <span class="ActionScriptDefault_Text">ed</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Boolean</span> <span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">v1</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> 0;
        <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">lx_coord</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">x_coord</span>; <span class="ActionScriptComment">// int[]
</span>        <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">ly_coord</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">y_coord</span>; <span class="ActionScriptComment">// int[]
</span>        <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">a</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">ly_coord</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">ed</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">ly_coord</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">st</span><span class="ActionScriptBracket/Brace">]</span>;
        <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">b</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">lx_coord</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">st</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">lx_coord</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">ed</span><span class="ActionScriptBracket/Brace">]</span>;
        <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">c</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">lx_coord</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">ed</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">ly_coord</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">st</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">ly_coord</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">ed</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">lx_coord</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">st</span><span class="ActionScriptBracket/Brace">]</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">dmax</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> 0;
        
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">d</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Number</span>;
        <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">st</span> <span class="ActionScriptOperator">+</span> 1; <span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">ed</span>; <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">d</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">a</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">lx_coord</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">b</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">ly_coord</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">c</span>;
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">d</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">d</span> <span class="ActionScriptOperator">&gt;</span> <span class="ActionScriptDefault_Text">dmax</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">dmax</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">d</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">d</span>;
                <span class="ActionScriptDefault_Text">v1</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">i</span>;
            <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">dmax</span> <span class="ActionScriptOperator">/</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">a</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">a</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">b</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">b</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">&gt;</span> <span class="ActionScriptDefault_Text">thresh</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(!</span><span class="ActionScriptDefault_Text">get_vertex</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">st</span>, <span class="ActionScriptDefault_Text">v1</span><span class="ActionScriptBracket/Brace">))</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">false</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">number_of_vertex</span> <span class="ActionScriptOperator">&gt;</span> 5<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">false</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptDefault_Text">vertex</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">number_of_vertex</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">v1</span>;
            <span class="ActionScriptComment">// vertex[(*vnum)] = v1;
</span>            <span class="ActionScriptDefault_Text">number_of_vertex</span><span class="ActionScriptOperator">++</span>;
            <span class="ActionScriptComment">// (*vnum)++;
</span>
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(!</span><span class="ActionScriptDefault_Text">get_vertex</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">v1</span>, <span class="ActionScriptDefault_Text">ed</span><span class="ActionScriptBracket/Brace">))</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">false</span>;
            <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">true</span>;
    <span class="ActionScriptBracket/Brace">}</span>
<span class="ActionScriptBracket/Brace">}</span>

<span class="ActionScriptASDoc">/**
 * ラベル同士の重なり（内包関係）を調べるクラスです。 ラベルリストに内包するラベルを蓄積し、それにターゲットのラベルが内包されているか を確認します。
 */</span>
<span class="ActionScriptclass">class</span> <span class="ActionScriptDefault_Text">OverlapChecker</span> <span class="ActionScriptBracket/Brace">{</span>

    <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_labels</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Array</span><span class="ActionScriptBracket/Brace">(</span>32<span class="ActionScriptBracket/Brace">)</span>; <span class="ActionScriptComment">// new FLARLabelingLabel[32];
</span>
    <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_length</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>;

    <span class="ActionScriptASDoc">/**
     * 最大i_max_label個のラベルを蓄積できるようにオブジェクトをリセットする
     * 
     * @param i_max_label
     */</span>
    <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">reset</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i_max_label</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i_max_label</span> <span class="ActionScriptOperator">&gt;</span> <span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">_labels</span>.<span class="ActionScriptDefault_Text">length</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
<span class="ActionScriptComment">//            this._labels = new FLARLabelingLabel[i_max_label];
</span>            <span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">_labels</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Array</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i_max_label</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">n</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">i_max_label</span>;
            <span class="ActionScriptReserved">while</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">n</span><span class="ActionScriptOperator">--</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">_labels</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">n</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">FLARLabelingLabel</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">_length</span> <span class="ActionScriptOperator">=</span> 0;
    <span class="ActionScriptBracket/Brace">}</span>

    <span class="ActionScriptASDoc">/**
     * チェック対象のラベルを追加する。
     * 
     * @param i_label_ref
     */</span>
    <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">push</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i_label_ref</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">FLARLabelingLabel</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">_labels</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">_length</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">i_label_ref</span>;
        <span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">_length</span><span class="ActionScriptOperator">++</span>;
    <span class="ActionScriptBracket/Brace">}</span>

    <span class="ActionScriptASDoc">/**
     * 現在リストにあるラベルと重なっているかを返す。
     * 
     * @param i_label
     * @return 何れかのラベルの内側にあるならばfalse,独立したラベルである可能性が高ければtrueです．
     */</span>
    <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">check</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i_label</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">FLARLabelingLabel</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Boolean</span> <span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptComment">// 重なり処理かな？
</span>        <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">label_pt</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">_labels</span>; <span class="ActionScriptComment">// FLARLabelingLabel[]
</span>        <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">px1</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">int</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i_label</span>.<span class="ActionScriptDefault_Text">pos_x</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">py1</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">int</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i_label</span>.<span class="ActionScriptDefault_Text">pos_y</span><span class="ActionScriptBracket/Brace">)</span>;
        
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">px2</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">py2</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">d</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>;
        <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">_length</span> <span class="ActionScriptOperator">-</span> 1;<span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">&gt;=</span> 0; <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">--</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">px2</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">int</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">label_pt</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span>.<span class="ActionScriptDefault_Text">pos_x</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">py2</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">int</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">label_pt</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span>.<span class="ActionScriptDefault_Text">pos_y</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">d</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">px1</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">px2</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">px1</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">px2</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">py1</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">py2</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">py1</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">py2</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">d</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">label_pt</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span>.<span class="ActionScriptDefault_Text">area</span> <span class="ActionScriptOperator">/</span> 4<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptComment">// 対象外
</span>                <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">false</span>;
            <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptComment">// 対象
</span>        <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">true</span>;
    <span class="ActionScriptBracket/Brace">}</span>
<span class="ActionScriptBracket/Brace">}</span></pre></body>
</html>
